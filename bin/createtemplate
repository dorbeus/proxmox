#!/bin/bash

ID="$1"
NAME="$2"
DEFAULTNAME="ubuntu-12.04-standard_12.04_amd64.tar.gz"
CTDIR="/var/lib/vz/private"
TEMPLATEDIR="/var/lib/vz/template/cache"

print_usage(){
	echo "Usage: $0 <VM ID> <archive name>"
	echo "Example: $0 100 ubuntu-12.04-standard_12.04_amd64.tar.gz"
}

# testing to see if the arguments exist before going any further
if [ -z $ID ]
then
	echo "VMID is not set."
	print_usage
	exit 1
fi


# Testing $ID
if [ ! $ID -ge 100 ]
then
	echo "Enter a VMID of 100 or greater."
	print_usage
	exit 1
fi

# test to see if the VM exists
echo "Testing for valid VM ID."
if [ ! -d "$CTDIR/$ID" ]
then
	echo "The VM $ID, does not exist. Please enter a valid VM ID."
	print_usage
	exit 1
fi

# testing $NAME
# testing to see if the arguments exist before going any further
if [ -z "$NAME" ]
then
        echo "NAME is not set."
	echo "Using default name $DEFAULTNAME"

else
	echo "Testing for valid archive name."
	if [[ "$NAME" != *".tar.gz" ]]
	then
		echo "Enter an archive/template name ending in '.tar.gz'"
		print_usage
		exit 1;
	fi
fi

# go to template directory
cd "$CTDIR/$ID"

echo "Backup old template file"
if [ -e "$TEMPLATEDIR/$NAME" ] && [ -e "$TEMPLATEDIR/$NAME.old" ]
then
	rm "$TEMPLATEDIR/$NAME.old"
fi

if [ -e "$TEMPLATEDIR/$NAME" ]
then
	mv "$TEMPLATEDIR/$NAME" "$TEMPLATEDIR/$NAME.old"
fi

# check to see if VM is running, if so do nothing, if not start VM
CTSTATUS=`vzctl status $ID`
if [[ ! "$CTSTATUS" == "*running" ]]                    
then                  
	vzctl start $ID
fi

#remove any ip address
vzctl set $ID --ipdel all --save
vzctl stop $ID

echo "Preapring fresh ssh keys"
sleep 2
#Generate a unique set of ssh (host) keys.
rm -f etc/ssh/ssh_host_*

cat << EOF > etc/rc2.d/S15ssh_gen_host_keys
#!/bin/sh
ssh-keygen -f /etc/ssh/ssh_host_rsa_key -t rsa -N ''
ssh-keygen -f /etc/ssh/ssh_host_dsa_key -t dsa -N ''
ssh-keygen -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N ''
rm -f \$0
EOF

cd "$CTDIR/$ID"

echo "Start creating Template"
sleep 5

tar -czvf "$TEMPLATEDIR/$NAME" .

echo "Done Packing up the tar archive"
sleep 3

echo "Done creating the template"
sleep 2

