# source: https://help.ubuntu.com/12.04/installation-guide/powerpc/linux-upgrade.html
# source: http://blog.bodhizazen.net/linux/ubuntu-10-04-openvz-templates/

CTID=900
USER=pklan.notification
EMAIL=$USER@gmail.com
PASS="password"

main(){
	debootstrap
#	createct
#	ct-config-apt
#	syslog
#	locales
#	resolvconf
#	unattended-upgrades
#	email
#	fail2ban
#	cleanup					
}

debootstrap(){
	# install debootstrap from ubuntu deb
	wget http://archive.ubuntu.com/ubuntu/pool/main/d/debootstrap/debootstrap_1.0.42_all.deb
	dpkg -i debootstrap_1.0.42_all.deb

	# create a directory in which you wish to install ubuntu.
	workingdir=/root/ubuntu-12.04-amd64_openvz-template
	mkdir $workingdir

	# install ubuntu base to $workingdir
	/usr/sbin/debootstrap --arch amd64 precise $workingdir

	# go to working dir and create a tar.gz of it for use with a template
	cd $workingdir

	# this tar.gz can then be uploaded to the proxmox server as a new template.
	tar -czvf /root/ubuntu-12.04-amd64_openvz.tar.gz .

	# copy to proxmox template cache
	cp /root/ubuntu-12.04-amd64_openvz.tar.gz /var/lib/vz/template/cache/
}

createct(){
	# create basic.conf
cat > /etc/vz/conf/basic.conf <<EOF
ONBOOT="yes"

PHYSPAGES="0:512M"
SWAPPAGES="0:512M"
KMEMSIZE="232M:256M"
DCACHESIZE="116M:128M"
LOCKEDPAGES="256M"
PRIVVMPAGES="unlimited"
SHMPAGES="unlimited"
NUMPROC="unlimited"
VMGUARPAGES="0:unlimited"
OOMGUARPAGES="0:unlimited"
NUMTCPSOCK="unlimited"
NUMFLOCK="unlimited"
NUMPTY="unlimited"
NUMSIGINFO="unlimited"
TCPSNDBUF="unlimited"
TCPRCVBUF="unlimited"
OTHERSOCKBUF="unlimited"
DGRAMRCVBUF="unlimited"
NUMOTHERSOCK="unlimited"
NUMFILE="unlimited"
NUMIPTENT="unlimited"

# Disk quota parameters (in form of softlimit:hardlimit)
DISKSPACE="4G:4613734"
DISKINODES="800000:880000"
QUOTATIME="0"
QUOTAUGIDLIMIT="0"

# CPU fair scheduler parameter
CPUUNITS="1000"
CPUS="1"
SEARCHDOMAIN="lan"
NAMESERVER="10.13.37.1"
NETIF=""
VE_ROOT="/var/lib/vz/root/$VEID"
VE_PRIVATE="/var/lib/vz/private/$VEID"
EOF

	# create new template CT
	vztctl create $CTID --ostemplate ubuntu-12.04-amd64_openvz --config basic --hostname template --ipaddr 10.13.37.253 --save
	vzctl start $CTID
}

ct-config-apt(){
	# configure apt
cat > /etc/apt/sources.list <<EOF
deb http://archive.ubuntu.com/ubuntu precise main restricted universe
deb http://archive.ubuntu.com/ubuntu precise-updates main restricted universe
deb http://archive.ubuntu.com/ubuntu precise-security main restricted universe
EOF
	# full upgrade
	apt-get update
	apt-get dist-upgrade -y

	# install tasksel and standard server files
	apt-get install tasksel -y
	tasksel install standard
	apt-get install ssh -y

	# install the man pages
	apt-get install man -y
}


syslog(){
	# rsyslog cause the cpu to go to 100% :(
	apt-get install syslog-ng -y
	apt-get remove rsyslog -y

	# fix for logrotate and syslog-ng
	sed -i 's|#SYSLOGNG_OPTS=|SYSLOGNG_OPTS=|' /etc/default/syslog-ng
}

locales(){
	# set locale
	locale-gen en_US
	locale-gen en_US.UTF-8
	dpkg-reconfigure locales

	# set timezone
	# dpkg-reconfigure tzdata
	ln -sf /usr/share/zoneinfo/America/Chicago /etc/localtime
}

resolvconf(){
	# we need this to fix issues with resolv.conf for dns when the template gets created
	apt-get purge resolvconf -y

	# write the local file
	update-locale
}

unattended-upgrades(){
	# install unattended upgrades
	apt-get install -y unattended-upgrades update-notifier-common

	cat > /etc/apt/apt.conf.d/10periodic <<EOF
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
EOF

	cp /etc/apt/apt.conf.d/50unattended-upgrades /etc/apt/apt.conf.d/unattended-upgrades.50.bak
	cat > /etc/apt/apt.conf.d/50unattended-upgrades <<EOF
Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
        "${distro_id}:${distro_codename}-updates";
};
EOF
}

email(){
	# sending email alerts
	apt-get install ssmtp -y

	cat > /etc/ssmtp/ssmtp.conf <<EOF
root=$EMAIL
mailhub=smtp.gmail.com:587
rewriteDomain=pklan.org
hostname=$EMAIL
UseSTARTTLS=YES
AuthUser=$USER
AuthPass=$PASS
FromLineOverride=YES
EOF
	
	chmod 640 /etc/ssmtp/ssmtp.conf

	cat > /etc/ssmtp/revaliases <<EOF
root:$EMAIL:smtp.gmail.com:587
EOF

}

fail2ban(){
	# Install fail2ban
	apt-get install fail2ban -y

	
}

cleanup(){
	# remove unnecessary files
	apt-get autoremove
	apt-get autoclean
	apt-get clean
}


case $1 in
	debian*)
		OS=
		main
	;;
	ubuntu*)
		OS=
		main
	;;
	*)
		echo "Options: debian, ubuntu"
		exit
	;;
esac
